<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Coin Ecosystem</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for the notification toast */
    #notification-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        transition: opacity 0.5s, transform 0.5s;
        opacity: 0;
        pointer-events: none;
        z-index: 100;
    }
    #notification-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
    }
  </style>
</head>
<body class="bg-black text-white font-sans">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Service Coin Ecosystem</h1>
    
    <div id="connect-wallet-container" class="text-center bg-gray-800 p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4">Connect Your Wallet</h2>
        <p id="wallet-instructions" class="text-gray-400 mb-6">Please connect your wallet to view the dashboard.</p>
        <button id="connect-wallet-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors text-lg">Connect Wallet</button>
    </div>

    <div id="dashboard-content" class="hidden">
        <!-- Wallet Info (Full Width) -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-md">
          <p><strong>Wallet:</strong> <span id="wallet">-</span></p>
          <p class="text-sm text-gray-400">View your verified holdings, staking receipts, and redemption timeline.</p>
        </div>

        <!-- Main Two-Column Layout -->
        <div class="grid lg:grid-cols-5 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Balances -->
                <div class="grid md:grid-cols-2 gap-4">
                  <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <p class="text-lg font-bold">SREV Balance</p>
                    <p id="srev-balance" class="text-2xl font-mono">0.00</p>
                    <p class="text-sm text-gray-400">Auto-yielding USDC receipt</p>
                  </div>
                  <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <p class="text-lg font-bold">PFLOW25</p>
                    <p id="lease-token" class="text-2xl font-mono">0</p>
                    <p class="text-sm text-gray-400">$10 Buy 10.80 Early Redeem after Cooldown period $12 redeemable after maturity</p>
                  </div>
                </div>

                <!-- Staking and LeaseToken Actions -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">SRV Staking & PFLOW25</h3>
                    <div class="flex flex-wrap gap-2">
                      <button id="stake" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Stake SRV</button>
                      <button id="unstake" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Unstake SRV</button>
                      <button id="redeemLeaseToken" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Redeem PFLOW25</button>
                      <button id="earlyRedeem" class="bg-white text-black font-bold py-2 px-4 rounded-lg transition-colors">Early Redeem</button>
                      <button id="buyLeaseToken" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Buy PFLOW25</button>
                    </div>
                </div>
                
                <!-- Investor Vault Actions -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Real Yield System</h3>
                    
                    <div class="mb-6 border-b border-gray-700 pb-6">
                        <label for="deposit-amount" class="block text-sm font-medium text-gray-300 mb-2">Deposit USDC to Real Yield System</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="deposit-amount" placeholder="USDC Amount" class="bg-gray-900 border border-gray-700 text-white rounded-lg p-2 flex-grow focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <button id="approve-deposit-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Approve</button>
                            <button id="deposit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>Deposit</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">First approve, then deposit.</p>
                    </div>
            
                    <div class="flex flex-wrap gap-2">
                        <button id="vault-claim-yield-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Claim Yield</button>
                        <button id="vault-compound-yield-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Compound Yield</button>
                        <button id="vault-withdraw-all-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Withdraw All</button>
                    </div>
                </div>
                 <!-- Vault Claimable Yield -->
                 <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <p class="text-lg font-bold">Vault Claimable Yield</p>
                    <p id="vault-claimable-yield" class="text-2xl font-mono">0.00</p>
                    <p class="text-sm text-gray-400">USDC earned in vault</p>
                  </div>
            </div>
            <!-- Right Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Platform Totals -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Platform Totals</h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Investor Vault Balance</p>
                            <p id="platform-investor-vault-balance" class="text-lg font-mono">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Total Capital Deposited</p>
                            <p id="platform-total-deposited" class="text-lg font-mono">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Yield Vault Balance</p>
                            <p id="platform-yield-vault-balance" class="text-lg font-mono">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Total Fees Processed</p>
                            <p id="platform-total-fees" class="text-lg font-mono">$0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="notification-toast" class="px-4 py-2 rounded-lg shadow-lg text-white">
      <span id="notification-message"></span>
  </div>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- ABIs and Contract Addresses ---
        const srevAbi = [{"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"}];
        // FIX: Using the complete ABI for the PFLOW25 contract
        const leaseBondAbi = [{"inputs":[{"internalType":"address","name":"usdcAddress","type":"address"},{"internalType":"uint256","name":"_purchasePrice","type":"uint256"},{"internalType":"uint256","name":"_redeemRate","type":"uint256"},{"internalType":"uint256","name":"_earlyRedeemRate","type":"uint256"},{"internalType":"uint256","name":"_durationSeconds","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"payout","type":"uint256"}],"name":"EarlyRedeemed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"payout","type":"uint256"}],"name":"Redeemed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"buy","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"earlyRedeem","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"earlyRedeemRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"enableTransfers","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fundVault","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastBuyTimestamp","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maturity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"purchasePrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"redeem","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"redeemRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"transfersEnabled","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdc","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"usdcBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];
        const stakingAbi = [{"inputs":[{"internalType":"address","name":"_srv","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"SREV","outputs":[{"internalType":"contract SREVToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"SRV","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSREV","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"staked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const erc20Abi = [
          "function approve(address spender, uint256 amount) external returns (bool)",
          "function balanceOf(address owner) view returns (uint256)",
          "function allowance(address owner, address spender) view returns (uint256)"
        ];
        const investorVaultAbi = [{"inputs":[{"internalType":"address","name":"_usdc","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharesMinted","type":"uint256"}],"name":"Deposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldKernel","type":"address"},{"indexed":true,"internalType":"address","name":"newKernel","type":"address"}],"name":"KernelUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharesBurned","type":"uint256"}],"name":"Withdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"YieldClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newShares","type":"uint256"}],"name":"YieldCompounded","type":"event"},{"inputs":[],"name":"LOCKUP_PERIOD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"investors","type":"address[]"}],"name":"batchClaimYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"investors","type":"address[]"}],"name":"batchWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"investor","type":"address"}],"name":"claimableYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"claimedYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"compoundYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"deposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"depositTimestamps","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fundKernel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"investor","type":"address"}],"name":"getInvestorInfo","outputs":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"uint256","name":"claimable","type":"uint256"},{"internalType":"uint256","name":"claimed","type":"uint256"},{"internalType":"uint256","name":"unlockTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVaultTotals","outputs":[{"internalType":"uint256","name":"totalUSDC","type":"uint256"},{"internalType":"uint256","name":"totalSharesMinted","type":"uint256"},{"internalType":"uint256","name":"totalYield","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"kernel","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"receiveYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_kernel","type":"address"}],"name":"setKernel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"shares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalDeposits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalYieldDistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdc","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shareAmount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const yieldVaultAbi = [{"inputs":[{"internalType":"address","name":"_governance","type":"address"},{"internalType":"address","name":"_kernel","type":"address"},{"internalType":"address","name":"_feeToken","type":"address"},{"internalType":"address","name":"_daoTreasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldTreasury","type":"address"},{"indexed":true,"internalType":"address","name":"newTreasury","type":"address"}],"name":"DaoTreasuryUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"fromKernel","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesDepositedInVault","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"treasury","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesSweptToTreasury","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldKernel","type":"address"},{"indexed":true,"internalType":"address","name":"newKernel","type":"address"}],"name":"KernelAddressUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"inputs":[],"name":"daoTreasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalFeesAccumulatedInVault","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVaultBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"kernelAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"recordFeeDeposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newTreasury","type":"address"}],"name":"setDaoTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newKernel","type":"address"}],"name":"setKernelAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"sweepFullBalanceToTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"sweepToTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalFeesAccumulatedInVault","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        const usdcAddress = "0xaf88d065e77c8cC2239327C5EDb3A432268e5831";
        const srevAddress = "0x2F745Da2FA453ee76c756fADcc081f59284B2a40";
        const leaseAddress = "0xd0dc6eeE2dD77d7A4C09108993d0c7ad6a0b60E3";
        const stakingContractAddress = "0x71f618EFb0422687e5B2ad9cD973aDACb645D9DE"; // This is the staking contract
        const investorVaultAddress = "0x1a51f1966d35661573908DC913307076d937aa90";
        const yieldVaultAddress = "0x44D64E1B9dC5F90b389900Da24B8de631222432C";

        // --- Ethers.js Setup ---
        let provider;
        let signer;

        // --- UI Elements ---
        const walletEl = document.getElementById("wallet");
        const srevBalanceEl = document.getElementById("srev-balance");
        const leaseTokenEl = document.getElementById("lease-token");
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        const connectWalletContainer = document.getElementById('connect-wallet-container');
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const walletInstructions = document.getElementById('wallet-instructions');
        const dashboardContent = document.getElementById('dashboard-content');
        const vaultClaimableYieldEl = document.getElementById('vault-claimable-yield');

        const depositAmountInput = document.getElementById('deposit-amount');
        const approveDepositBtn = document.getElementById('approve-deposit-btn');
        const depositBtn = document.getElementById('deposit-btn');
        const vaultClaimYieldBtn = document.getElementById('vault-claim-yield-btn');
        const vaultCompoundYieldBtn = document.getElementById('vault-compound-yield-btn');
        const vaultWithdrawAllBtn = document.getElementById('vault-withdraw-all-btn');
        
        const stakeBtn = document.getElementById('stake');
        const unstakeBtn = document.getElementById('unstake');
        const redeemLeaseTokenBtn = document.getElementById('redeemLeaseToken');
        const earlyRedeemBtn = document.getElementById('earlyRedeem');
        const buyLeaseTokenBtn = document.getElementById('buyLeaseToken');

        // Platform Totals UI Elements
        const platformInvestorVaultBalanceEl = document.getElementById('platform-investor-vault-balance');
        const platformTotalDepositedEl = document.getElementById('platform-total-deposited');
        const platformYieldVaultBalanceEl = document.getElementById('platform-yield-vault-balance');
        const platformTotalFeesEl = document.getElementById('platform-total-fees');


        // --- Helper Functions ---
        function showNotification(message, isError = false) {
            notificationMessage.textContent = message;
            notificationToast.className = `px-4 py-2 rounded-lg shadow-lg text-white ${isError ? 'bg-red-600' : 'bg-gray-700'}`;
            notificationToast.classList.add('show');
            setTimeout(() => { notificationToast.classList.remove('show'); }, 4000);
        }

        function formatCurrency(value) {
            return `$${parseFloat(value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // --- Core Application Logic ---
        async function connectAndLoadDashboard() {
          try {
            provider = new ethers.providers.Web3Provider(window.ethereum, "any");
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const user = await signer.getAddress();
            walletEl.innerText = `${user.substring(0, 6)}...${user.substring(user.length - 4)}`;

            const srev = new ethers.Contract(srevAddress, srevAbi, provider);
            const lease = new ethers.Contract(leaseAddress, leaseBondAbi, provider);
            const investorVault = new ethers.Contract(investorVaultAddress, investorVaultAbi, provider);
            const yieldVault = new ethers.Contract(yieldVaultAddress, yieldVaultAbi, provider);

            const [
                srevBal, 
                leaseBal, 
                vaultYield,
                investorVaultTotals,
                totalCapitalDeposited,
                yieldVaultBalance,
                totalFees
            ] = await Promise.all([
                srev.balanceOf(user),
                lease.balanceOf(user),
                investorVault.claimableYield(user),
                investorVault.getVaultTotals(),
                investorVault.totalDeposits(),
                yieldVault.getVaultBalance(),
                yieldVault.totalFeesAccumulatedInVault()
            ]);
            
            srevBalanceEl.innerText = parseFloat(ethers.utils.formatUnits(srevBal, 18)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            leaseTokenEl.innerText = leaseBal.toString();
            vaultClaimableYieldEl.innerText = parseFloat(ethers.utils.formatUnits(vaultYield, 6)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            platformInvestorVaultBalanceEl.innerText = formatCurrency(ethers.utils.formatUnits(investorVaultTotals.totalUSDC, 6));
            platformTotalDepositedEl.innerText = formatCurrency(ethers.utils.formatUnits(totalCapitalDeposited, 6));
            platformYieldVaultBalanceEl.innerText = formatCurrency(ethers.utils.formatUnits(yieldVaultBalance, 6));
            platformTotalFeesEl.innerText = formatCurrency(ethers.utils.formatUnits(totalFees, 6));


            connectWalletContainer.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
          } catch (error) {
            console.error("Connection/data fetch failed:", error);
            showNotification("Failed to connect to wallet or fetch data.", true);
          }
        }
        
        // --- Action Handlers ---
        async function handleContractInteraction(action, successMessage, failureMessage, suggestions = "") {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            showNotification(`${failureMessage}...`);
            try {
                const tx = await action();
                await tx.wait();
                showNotification(successMessage, false);
                connectAndLoadDashboard();
            } catch (error) {
                console.error(`${failureMessage} failed:`, error);
                const reason = error.reason || "transaction reverted without a reason string.";
                showNotification(`${failureMessage} failed: ${reason} ${suggestions}`, true);
            }
        }

        async function handleApproveDeposit() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = depositAmountInput.value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return showNotification("Please enter a valid amount.", true);
            }
            const usdc = new ethers.Contract(usdcAddress, erc20Abi, signer);
            await handleContractInteraction(
                () => usdc.approve(investorVaultAddress, ethers.utils.parseUnits(amount, 6)),
                "Approval successful! You can now deposit.",
                "Approving"
            );
            depositBtn.disabled = false;
            depositBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        async function handleDeposit() {
             if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = depositAmountInput.value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return showNotification("Please enter a valid amount.", true);
            }
            const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
            await handleContractInteraction(
                () => vault.deposit(ethers.utils.parseUnits(amount, 6)),
                "Deposit successful!",
                "Depositing"
            );
            depositAmountInput.value = ""; 
            depositBtn.disabled = true; 
            depositBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        async function handleVaultClaim() {
            const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
            await handleContractInteraction(() => vault.claimYield(), "Yield claimed!", "Claiming yield");
        }

        async function handleVaultCompound() {
            const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
            await handleContractInteraction(() => vault.compoundYield(), "Yield compounded!", "Compounding yield");
        }

        async function handleVaultWithdraw() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
            const user = await signer.getAddress();
            showNotification("Fetching your shares to withdraw...");
            const userShares = await vault.shares(user);
            if (userShares.isZero()) {
                return showNotification("You have no shares to withdraw.", true);
            }
            await handleContractInteraction(() => vault.withdraw(userShares), "Withdrawal successful!", "Withdrawing all funds");
        }

        async function handleBuyLeaseToken() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = prompt("Enter amount of USDC to spend:");
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                if (amount !== null) showNotification("Invalid amount entered.", true);
                return;
            }
            const leaseBond = new ethers.Contract(leaseAddress, leaseBondAbi, signer);
            const usdc = new ethers.Contract(usdcAddress, erc20Abi, signer);
            showNotification("Approving USDC spend...");
            try {
                const txApprove = await usdc.approve(leaseAddress, ethers.utils.parseUnits(amount, 6));
                await txApprove.wait(); 
                await handleContractInteraction(() => leaseBond.buy(ethers.utils.parseUnits(amount, 6)), "Lease token purchased successfully!", "Processing purchase");
            } catch (error) {
                console.error("Purchase failed:", error);
                showNotification(error.reason || "Purchase transaction failed.", true);
            }
        }

        async function handleStakeSrv() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = prompt("Enter amount of SRV to stake:");
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                if (amount !== null) showNotification("Invalid amount entered.", true);
                return;
            }
            const stakingContract = new ethers.Contract(stakingContractAddress, stakingAbi, signer);
            showNotification("Approving SRV for staking...");
            try {
                const srvTokenAddress = await stakingContract.SRV();
                const srvTokenContract = new ethers.Contract(srvTokenAddress, erc20Abi, signer);

                const txApprove = await srvTokenContract.approve(stakingContractAddress, ethers.utils.parseUnits(amount, 18));
                await txApprove.wait();
                await handleContractInteraction(() => stakingContract.stake(ethers.utils.parseUnits(amount, 18)), "SRV staked successfully!", "Staking SRV", "Ensure you have enough SRV.");
            } catch (error) {
                console.error("Stake SRV failed:", error);
                showNotification(error.reason || "Stake SRV failed.", true);
            }
        }

        async function handleUnstakeSrv() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            
            try {
                const stakingContract = new ethers.Contract(stakingContractAddress, stakingAbi, signer);
                const user = await signer.getAddress();

                showNotification("Fetching your staked balance...");
                const stakedBalanceWei = await stakingContract.staked(user);

                if (stakedBalanceWei.isZero()) {
                    return showNotification("You have no SRV to unstake.", true);
                }
                
                const stakedAmount = ethers.utils.formatUnits(stakedBalanceWei, 18);
                const amountToUnstakeStr = prompt(`Enter amount of SRV to unstake (max: ${stakedAmount}):`);
                
                if (!amountToUnstakeStr || isNaN(amountToUnstakeStr) || parseFloat(amountToUnstakeStr) <= 0) {
                    if (amountToUnstakeStr !== null) showNotification("Invalid amount entered.", true);
                    return;
                }

                const amountToUnstakeWei = ethers.utils.parseUnits(amountToUnstakeStr, 18);

                if (amountToUnstakeWei.gt(stakedBalanceWei)) {
                    return showNotification("Amount exceeds your staked balance.", true);
                }
                
                await handleContractInteraction(
                    () => stakingContract.unstake(amountToUnstakeWei),
                    "SRV unstaked successfully!",
                    "Unstaking SRV",
                    "Ensure you have enough staked and are past any lock-up period."
                );

            } catch (error) {
                 console.error("Unstake SRV failed:", error);
                 const reason = error.reason || "transaction reverted without a reason.";
                 showNotification(`Unstake SRV failed: ${reason}`, true);
            }
        }

        async function handleRedeemLeaseToken() {
            const leaseContract = new ethers.Contract(leaseAddress, leaseBondAbi, signer);
            await handleContractInteraction(() => leaseContract.redeem(), "PFLOW25 redeemed successfully!", "Redeeming PFLOW25", "Ensure the token has reached maturity.");
        }

        async function handleEarlyRedeem() {
            const leaseContract = new ethers.Contract(leaseAddress, leaseBondAbi, signer);
            await handleContractInteraction(() => leaseContract.earlyRedeem(), "Early redeem successful!", "Executing early redeem", "Ensure you are eligible for early redemption.");
        }


        // --- Event Listeners Setup ---
        connectWalletBtn.addEventListener('click', () => {
            if (typeof window.ethereum !== 'undefined') {
                connectAndLoadDashboard();
            } else {
                showNotification("No wallet detected. Please install MetaMask.", true);
                walletInstructions.textContent = "No web3 wallet detected. Please install a wallet like MetaMask to continue.";
                connectWalletBtn.textContent = "Install MetaMask";
                connectWalletBtn.onclick = () => { window.open("https://metamask.io/download/", "_blank"); };
            }
        });
        
        depositAmountInput.addEventListener('input', () => {
            depositBtn.disabled = true;
            depositBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });

        approveDepositBtn.addEventListener('click', handleApproveDeposit);
        depositBtn.addEventListener('click', handleDeposit);
        vaultClaimYieldBtn.addEventListener('click', handleVaultClaim);
        vaultCompoundYieldBtn.addEventListener('click', handleVaultCompound);
        vaultWithdrawAllBtn.addEventListener('click', handleVaultWithdraw);
        
        buyLeaseTokenBtn.addEventListener('click', handleBuyLeaseToken);
        stakeBtn.addEventListener('click', handleStakeSrv);
        unstakeBtn.addEventListener('click', handleUnstakeSrv);
        redeemLeaseTokenBtn.addEventListener('click', handleRedeemLeaseToken);
        earlyRedeemBtn.addEventListener('click', handleEarlyRedeem);

    });
  </script>
</body>
</ht
