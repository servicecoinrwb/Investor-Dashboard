<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Coin Ecosystem</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for the notification toast */
    #notification-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        transition: opacity 0.5s, transform 0.5s;
        opacity: 0;
        pointer-events: none;
        z-index: 100;
    }
    #notification-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
    }
  </style>
</head>
<body class="bg-black text-white font-sans">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Service Coin Ecosystem</h1>
    
    <div id="connect-wallet-container" class="text-center bg-gray-800 p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4">Connect Your Wallet</h2>
        <p id="wallet-instructions" class="text-gray-400 mb-6">Please connect your wallet to view the dashboard.</p>
        <button id="connect-wallet-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors text-lg">Connect Wallet</button>
    </div>

    <div id="dashboard-content" class="hidden">
        <!-- Wallet Info (Full Width) -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-md">
          <p><strong>Wallet:</strong> <span id="wallet">-</span></p>
          <p class="text-sm text-gray-400">View your verified holdings, staking receipts, and redemption timeline.</p>
        </div>

        <!-- Main Two-Column Layout -->
        <div class="grid lg:grid-cols-5 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Balances -->
                <div class="grid md:grid-cols-2 gap-4">
                  <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <p class="text-lg font-bold">SRV Balance</p>
                    <p id="srv-balance" class="text-2xl font-mono">0.00</p>
                    <p class="text-sm text-gray-400">The token required for staking.</p>
                  </div>
                   <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <p class="text-lg font-bold">SREV Balance</p>
                    <p id="srev-balance" class="text-2xl font-mono">0.00</p>
                    <p class="text-sm text-gray-400">Auto-yielding USDC receipt</p>
                  </div>
                </div>

                <!-- Staking Actions -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">SRV Staking</h3>
                     <div class="mb-6 border-b border-gray-700 pb-6">
                        <label for="stake-amount" class="block text-sm font-medium text-gray-300 mb-2">Stake SRV</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="stake-amount" placeholder="SRV Amount" class="bg-gray-900 border border-gray-700 text-white rounded-lg p-2 flex-grow focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <button id="approve-stake-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Approve SRV</button>
                            <button id="stake-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>Stake</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">First approve, then stake.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                      <button id="unstake" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Unstake SRV</button>
                    </div>
                </div>
                
                <!-- Investor Vault Actions -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Real Yield System</h3>
                    
                    <div class="mb-6 border-b border-gray-700 pb-6">
                        <label for="deposit-amount" class="block text-sm font-medium text-gray-300 mb-2">Deposit USDC to Real Yield System</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="deposit-amount" placeholder="USDC Amount" class="bg-gray-900 border border-gray-700 text-white rounded-lg p-2 flex-grow focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <button id="approve-deposit-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Approve</button>
                            <button id="deposit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>Deposit</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">First approve, then deposit.</p>
                    </div>
            
                    <div class="flex flex-wrap gap-2">
                        <button id="vault-claim-yield-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Claim Yield</button>
                        <button id="vault-compound-yield-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Compound Yield</button>
                        <button id="vault-withdraw-all-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Withdraw All</button>
                    </div>
                </div>
                 <!-- Vault Claimable Yield -->
                 <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <p class="text-lg font-bold">Vault Claimable Yield</p>
                    <p id="vault-claimable-yield" class="text-2xl font-mono">0.00</p>
                    <p class="text-sm text-gray-400">USDC earned in vault</p>
                  </div>
            </div>
            <!-- Right Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Platform Totals -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Platform Totals</h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Investor Vault Balance</p>
                            <p id="platform-investor-vault-balance" class="text-lg font-mono">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Total Capital Deposited</p>
                            <p id="platform-total-deposited" class="text-lg font-mono">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Yield Vault Balance</p>
                            <p id="platform-yield-vault-balance" class="text-lg font-mono">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Total Fees Processed</p>
                            <p id="platform-total-fees" class="text-lg font-mono">$0.00</p>
                        </div>
                    </div>
                </div>
                 <!-- Staking Yield Pool -->
                 <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Staking Yield Pool</h3>
                    <p class="text-sm">Pool Balance: <span id="staking-pool-balance">0.00 USDC</span></p>
                    <p class="text-sm">Your Pending Rewards: <span id="staking-pending-rewards">0.00 USDC</span></p>
                    <button id="claim-staking-yield-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full">Claim Yield (Staking)</button>
                  </div>
            </div>
        </div>
    </div>
  </div>

  <div id="notification-toast" class="px-4 py-2 rounded-lg shadow-lg text-white">
      <span id="notification-message"></span>
  </div>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- ABIs and Contract Addresses ---
        const srevAbi = [{"inputs":[{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"symbol","type":"string"},{"internalType":"string","name":"logo","type":"string"},{"internalType":"uint8","name":"decimals","type":"uint8"},{"internalType":"uint256","name":"initialSupply","type":"uint256"},{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"address","name":"treasury","type":"address"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"address","name":"tokenStore","type":"address"},{"components":[{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"transferFee","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"burn","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"reflection","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"buyback","type":"tuple"}],"internalType":"struct ITokenLauncherERC20.Fees","name":"fees","type":"tuple"},{"internalType":"address","name":"buybackHandler","type":"address"},{"internalType":"enum ITokenLauncherCommon.PaymentMethod","name":"paymentMethod","type":"uint8"}],"internalType":"struct ITokenLauncherERC20.CreateErc20Input","name":"_input","type":"tuple"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"router","type":"address"},{"indexed":true,"internalType":"address","name":"pairToken","type":"address"},{"indexed":false,"internalType":"uint256","name":"liquidityBasisPoints","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"priceImpactBasisPoints","type":"uint256"}],"name":"BuyBackDetailsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"pool","type":"address"}],"name":"ExchangePoolAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"pool","type":"address"}],"name":"ExchangePoolRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"}],"name":"ExemptedAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"}],"name":"ExemptedRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"newTokenLauncher","type":"address"}],"name":"TokenLauncherUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"string","name":"taxType","type":"string"}],"name":"TransferTax","type":"event"},{"inputs":[],"name":"BURN_ADDRESS","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_MANAGER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MULTIPLIER_BASIS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"pool","type":"address"}],"name":"addExchangePool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"addExemptAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buybackDetails","outputs":[{"internalType":"address","name":"pairToken","type":"address"},{"internalType":"address","name":"router","type":"address"},{"internalType":"uint256","name":"liquidityBasisPoints","type":"uint256"},{"internalType":"uint256","name":"priceImpactBasisPoints","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buybackHandler","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"excludeAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"fees","outputs":[{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"transferFee","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"burn","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"reflection","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"buyback","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"includeAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"pool","type":"address"}],"name":"isExchangePool","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"isExcludedFromReflectionRewards","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"isExemptedFromTax","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isReflectionToken","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"logo","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tAmount","type":"uint256"}],"name":"reflect","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tAmount","type":"uint256"},{"internalType":"bool","name":"deductTransferFee","type":"bool"}],"name":"reflectionFromToken","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"pool","type":"address"}],"name":"removeExchangePool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"removeExemptAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"address","name":"pairToken","type":"address"},{"internalType":"address","name":"router","type":"address"},{"internalType":"uint256","name":"liquidityBasisPoints","type":"uint256"},{"internalType":"uint256","name":"priceImpactBasisPoints","type":"uint256"}],"internalType":"struct ITokenLauncherLiquidityPoolFactory.BuyBackDetails","name":"_buybackDetails","type":"tuple"}],"name":"setBuybackDetails","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rAmount","type":"uint256"}],"name":"tokenFromReflection","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tokenLauncher","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalFees","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalReflection","outputs":[{"internalType":"uint256","name":"t","type":"uint256"},{"internalType":"uint256","name":"r","type":"uint256"},{"internalType":"uint256","name":"tFee","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"components":[{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"transferFee","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"burn","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"reflection","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"buyback","type":"tuple"}],"internalType":"struct ITokenLauncherERC20.Fees","name":"_fees","type":"tuple"}],"name":"updateFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newTokenLauncher","type":"address"}],"name":"updateTokenLauncher","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const stakingAbi = [{"inputs":[{"internalType":"address","name":"_srv","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"SREV","outputs":[{"internalType":"contract SREVToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"SRV","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSREV","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"staked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const rewardDistributorAbi = [{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"},{"internalType":"address","name":"_srevToken","type":"address"},{"internalType":"address","name":"_daoOperator","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newAPR","type":"uint256"}],"name":"APRUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newInterval","type":"uint256"}],"name":"ClaimIntervalUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Claimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdrawal","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"status","type":"bool"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardFunded","type":"event"},{"inputs":[],"name":"BPS_DIVISOR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"SECONDS_IN_YEAR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"users","type":"address[]"}],"name":"accrueAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"baseAPR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimInterval","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"daoOperator","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fund","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastClaimTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastClaimed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"newAPR","type":"uint256"}],"name":"setBaseAPR","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newInterval","type":"uint256"}],"name":"setClaimInterval","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"_paused","type":"bool"}],"name":"setPaused","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"srevToken","outputs":[{"internalType":"contract ISREVToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"viewClaimCooldown","outputs":[{"internalType":"uint256","name":"secondsUntilClaimable","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"viewPending","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"viewRewardPoolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];
        const investorVaultAbi = [{"inputs":[{"internalType":"address","name":"_usdc","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharesMinted","type":"uint256"}],"name":"Deposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldKernel","type":"address"},{"indexed":true,"internalType":"address","name":"newKernel","type":"address"}],"name":"KernelUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharesBurned","type":"uint256"}],"name":"Withdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"YieldClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newShares","type":"uint256"}],"name":"YieldCompounded","type":"event"},{"inputs":[],"name":"LOCKUP_PERIOD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"investors","type":"address[]"}],"name":"batchClaimYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"investors","type":"address[]"}],"name":"batchWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"investor","type":"address"}],"name":"claimableYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"claimedYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"compoundYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"deposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"depositTimestamps","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fundKernel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"investor","type":"address"}],"name":"getInvestorInfo","outputs":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"uint256","name":"claimable","type":"uint256"},{"internalType":"uint256","name":"claimed","type":"uint256"},{"internalType":"uint256","name":"unlockTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVaultTotals","outputs":[{"internalType":"uint256","name":"totalUSDC","type":"uint256"},{"internalType":"uint256","name":"totalSharesMinted","type":"uint256"},{"internalType":"uint256","name":"totalYield","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"kernel","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"receiveYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_kernel","type":"address"}],"name":"setKernel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"shares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalDeposits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalYieldDistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdc","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shareAmount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const yieldVaultAbi = [{"inputs":[{"internalType":"address","name":"_governance","type":"address"},{"internalType":"address","name":"_kernel","type":"address"},{"internalType":"address","name":"_feeToken","type":"address"},{"internalType":"address","name":"_daoTreasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldTreasury","type":"address"},{"indexed":true,"internalType":"address","name":"newTreasury","type":"address"}],"name":"DaoTreasuryUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"fromKernel","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesDepositedInVault","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"treasury","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesSweptToTreasury","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldKernel","type":"address"},{"indexed":true,"internalType":"address","name":"newKernel","type":"address"}],"name":"KernelAddressUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"inputs":[],"name":"daoTreasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalFeesAccumulatedInVault","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVaultBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"kernelAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"recordFeeDeposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newTreasury","type":"address"}],"name":"setDaoTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newKernel","type":"address"}],"name":"setKernelAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"sweepFullBalanceToTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"sweepToTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalFeesAccumulatedInVault","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        const usdcAddress = "0xaf88d065e77c8cC2239327C5EDb3A432268e5831";
        const srevAddress = "0x2F745Da2FA453ee76c756fADcc081f59284B2a40";
        const leaseAddress = "0xd0dc6eeE2dD77d7A4C09108993d0c7ad6a0b60E3";
        const rewardDistributorAddress = "0x71f618EFb0422687e5B2ad9cD973aDACb645D9DE";
        const stakingVaultAddress = "0x691e29E98ECDc5ae948355F30102cD4D637eddB7";
        const investorVaultAddress = "0x1a51f1966d35661573908DC913307076d937aa90";
        const yieldVaultAddress = "0x44D64E1B9dC5F90b389900Da24B8de631222432C";
        // FIX: Restore the standard ERC20 ABI to the correct scope
        const erc20Abi = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function balanceOf(address owner) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        // --- Ethers.js Setup ---
        let provider;
        let signer;

        // --- UI Elements ---
        const walletEl = document.getElementById("wallet");
        const srevBalanceEl = document.getElementById("srev-balance");
        const srvBalanceEl = document.getElementById("srv-balance");
        const leaseTokenEl = document.getElementById("lease-token");
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        const connectWalletContainer = document.getElementById('connect-wallet-container');
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const walletInstructions = document.getElementById('wallet-instructions');
        const dashboardContent = document.getElementById('dashboard-content');
        const vaultClaimableYieldEl = document.getElementById('vault-claimable-yield');

        const depositAmountInput = document.getElementById('deposit-amount');
        const approveDepositBtn = document.getElementById('approve-deposit-btn');
        const depositBtn = document.getElementById('deposit-btn');
        const vaultClaimYieldBtn = document.getElementById('vault-claim-yield-btn');
        const vaultCompoundYieldBtn = document.getElementById('vault-compound-yield-btn');
        const vaultWithdrawAllBtn = document.getElementById('vault-withdraw-all-btn');
        
        const stakeAmountInput = document.getElementById('stake-amount');
        const approveStakeBtn = document.getElementById('approve-stake-btn');
        const stakeBtn = document.getElementById('stake-btn');
        const unstakeBtn = document.getElementById('unstake');
        const claimStakingYieldBtn = document.getElementById('claim-staking-yield-btn');
        
        // Platform & Staking Totals UI Elements
        const platformInvestorVaultBalanceEl = document.getElementById('platform-investor-vault-balance');
        const platformTotalDepositedEl = document.getElementById('platform-total-deposited');
        const platformYieldVaultBalanceEl = document.getElementById('platform-yield-vault-balance');
        const platformTotalFeesEl = document.getElementById('platform-total-fees');
        const stakingPoolBalanceEl = document.getElementById('staking-pool-balance');
        const stakingPendingRewardsEl = document.getElementById('staking-pending-rewards');

        // --- Helper Functions ---
        function showNotification(message, isError = false) {
            notificationMessage.textContent = message;
            notificationToast.className = `px-4 py-2 rounded-lg shadow-lg text-white ${isError ? 'bg-red-600' : 'bg-gray-700'}`;
            notificationToast.classList.add('show');
            setTimeout(() => { notificationToast.classList.remove('show'); }, 4000);
        }

        function formatCurrency(value) {
            return `$${parseFloat(value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // --- Core Application Logic ---
        async function connectAndLoadDashboard() {
          try {
            provider = new ethers.providers.Web3Provider(window.ethereum, "any");
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const user = await signer.getAddress();
            walletEl.innerText = `${user.substring(0, 6)}...${user.substring(user.length - 4)}`;

            const srev = new ethers.Contract(srevAddress, srevAbi, provider);
            const rewardDistributor = new ethers.Contract(rewardDistributorAddress, rewardDistributorAbi, provider);
            const investorVault = new ethers.Contract(investorVaultAddress, investorVaultAbi, provider);
            const yieldVault = new ethers.Contract(yieldVaultAddress, yieldVaultAbi, provider);
            const stakingVault = new ethers.Contract(stakingVaultAddress, stakingAbi, provider);
            const srvTokenAddress = await stakingVault.SRV();
            const srv = new ethers.Contract(srvTokenAddress, erc20Abi, provider);


            const [
                srevBal,
                srvBal, 
                vaultYield,
                investorVaultTotals,
                totalCapitalDeposited,
                yieldVaultBalance,
                totalFees,
                stakingPoolBalance,
                stakingPendingRewards,
            ] = await Promise.all([
                srev.balanceOf(user),
                srv.balanceOf(user),
                investorVault.claimableYield(user),
                investorVault.getVaultTotals(),
                investorVault.totalDeposits(),
                yieldVault.getVaultBalance(),
                yieldVault.totalFeesAccumulatedInVault(),
                rewardDistributor.viewRewardPoolBalance(),
                rewardDistributor.viewPending(user),
            ]);
            
            srevBalanceEl.innerText = parseFloat(ethers.utils.formatUnits(srevBal, 18)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            srvBalanceEl.innerText = parseFloat(ethers.utils.formatUnits(srvBal, 18)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            vaultClaimableYieldEl.innerText = parseFloat(ethers.utils.formatUnits(vaultYield, 6)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            platformInvestorVaultBalanceEl.innerText = formatCurrency(ethers.utils.formatUnits(investorVaultTotals.totalUSDC, 6));
            platformTotalDepositedEl.innerText = formatCurrency(ethers.utils.formatUnits(totalCapitalDeposited, 6));
            platformYieldVaultBalanceEl.innerText = formatCurrency(ethers.utils.formatUnits(yieldVaultBalance, 6));
            platformTotalFeesEl.innerText = formatCurrency(ethers.utils.formatUnits(totalFees, 6));
            
            stakingPoolBalanceEl.innerText = `${parseFloat(ethers.utils.formatUnits(stakingPoolBalance, 6)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} USDC`;
            stakingPendingRewardsEl.innerText = `${parseFloat(ethers.utils.formatUnits(stakingPendingRewards, 18)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} USDC`;

            connectWalletContainer.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
          } catch (error) {
            console.error("Connection/data fetch failed:", error);
            showNotification("Failed to connect to wallet or fetch data.", true);
          }
        }
        
        // --- Action Handlers ---
        async function handleContractInteraction(action, successMessage, failureMessage, suggestions = "") {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            showNotification(`${failureMessage}...`);
            try {
                const tx = await action();
                await tx.wait();
                showNotification(successMessage, false);
                connectAndLoadDashboard();
            } catch (error) {
                console.error(`${failureMessage} failed:`, error);
                const reason = error.reason || "transaction reverted without a reason string.";
                showNotification(`${failureMessage} failed: ${reason} ${suggestions}`, true);
            }
        }

        async function handleApproveDeposit() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = depositAmountInput.value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return showNotification("Please enter a valid amount.", true);
            }
            const usdc = new ethers.Contract(usdcAddress, erc20Abi, signer);
            await handleContractInteraction(
                () => usdc.approve(investorVaultAddress, ethers.utils.parseUnits(amount, 6)),
                "Approval successful! You can now deposit.",
                "Approving"
            );
            depositBtn.disabled = false;
            depositBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        async function handleDeposit() {
             if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = depositAmountInput.value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return showNotification("Please enter a valid amount.", true);
            }
            const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
            await handleContractInteraction(
                () => vault.deposit(ethers.utils.parseUnits(amount, 6)),
                "Deposit successful!",
                "Depositing"
            );
            depositAmountInput.value = ""; 
            depositBtn.disabled = true; 
            depositBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        async function handleVaultClaim() {
            const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
            await handleContractInteraction(() => vault.claimYield(), "Yield claimed!", "Claiming yield");
        }

        async function handleVaultCompound() {
            const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
            await handleContractInteraction(() => vault.compoundYield(), "Yield compounded!", "Compounding yield");
        }

        async function handleVaultWithdraw() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
            const user = await signer.getAddress();
            showNotification("Fetching your shares to withdraw...");
            const userShares = await vault.shares(user);
            if (userShares.isZero()) {
                return showNotification("You have no shares to withdraw.", true);
            }
            await handleContractInteraction(() => vault.withdraw(userShares), "Withdrawal successful!", "Withdrawing all funds");
        }
        
        async function handleStakingClaim() {
            const rewardDistributor = new ethers.Contract(rewardDistributorAddress, rewardDistributorAbi, signer);
            await handleContractInteraction(() => rewardDistributor.claim(), "Staking rewards claimed!", "Claiming staking rewards");
        }
        
        async function handleApproveStake() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = stakeAmountInput.value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return showNotification("Please enter a valid amount.", true);
            }
            
            const stakingContract = new ethers.Contract(stakingVaultAddress, stakingAbi, signer);
            const srvTokenAddress = await stakingContract.SRV();
            const srvTokenContract = new ethers.Contract(srvTokenAddress, erc20Abi, signer);
            const user = await signer.getAddress();
            const srvBalance = await srvTokenContract.balanceOf(user);
            const amountWei = ethers.utils.parseUnits(amount, 18);

            if(amountWei.gt(srvBalance)) {
                return showNotification("Amount exceeds your SRV balance.", true);
            }
            
            await handleContractInteraction(
                () => srvTokenContract.approve(stakingVaultAddress, amountWei),
                "SRV Approved! You can now stake.",
                "Approving SRV"
            );
            stakeBtn.disabled = false;
            stakeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        async function handleStakeSrv() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = stakeAmountInput.value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return showNotification("Please enter a valid amount.", true);
            }
            const stakingContract = new ethers.Contract(stakingVaultAddress, stakingAbi, signer);
            await handleContractInteraction(() => stakingContract.stake(ethers.utils.parseUnits(amount, 18)), "SRV staked successfully!", "Staking SRV");
            stakeAmountInput.value = "";
            stakeBtn.disabled = true;
            stakeBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        async function handleUnstakeSrv() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            
            try {
                const stakingContract = new ethers.Contract(stakingVaultAddress, stakingAbi, signer);
                const user = await signer.getAddress();

                showNotification("Fetching your staked balance...");
                const stakedBalanceWei = await stakingContract.staked(user);

                if (stakedBalanceWei.isZero()) {
                    return showNotification("You have no SRV to unstake.", true);
                }
                
                const stakedAmount = ethers.utils.formatUnits(stakedBalanceWei, 18);
                const amountToUnstakeStr = prompt(`Enter amount of SRV to unstake (max: ${stakedAmount}):`);
                
                if (!amountToUnstakeStr || isNaN(amountToUnstakeStr) || parseFloat(amountToUnstakeStr) <= 0) {
                    if (amountToUnstakeStr !== null) showNotification("Invalid amount entered.", true);
                    return;
                }

                const amountToUnstakeWei = ethers.utils.parseUnits(amountToUnstakeStr, 18);

                if (amountToUnstakeWei.gt(stakedBalanceWei)) {
                    return showNotification("Amount exceeds your staked balance.", true);
                }
                
                await handleContractInteraction(
                    () => stakingContract.unstake(amountToUnstakeWei),
                    "SRV unstaked successfully!",
                    "Unstaking SRV",
                    "Ensure you have enough staked and are past any lock-up period."
                );

            } catch (error) {
                 console.error("Unstake SRV failed:", error);
                 const reason = error.reason || "transaction reverted without a reason.";
                 showNotification(`Unstake SRV failed: ${reason}`, true);
            }
        }

        // --- Event Listeners Setup ---
        connectWalletBtn.addEventListener('click', () => {
            if (typeof window.ethereum !== 'undefined') {
                connectAndLoadDashboard();
            } else {
                showNotification("No wallet detected. Please install MetaMask.", true);
                walletInstructions.textContent = "No web3 wallet detected. Please install a wallet like MetaMask to continue.";
                connectWalletBtn.textContent = "Install MetaMask";
                connectWalletBtn.onclick = () => { window.open("https://metamask.io/download/", "_blank"); };
            }
        });
        
        depositAmountInput.addEventListener('input', () => {
            depositBtn.disabled = true;
            depositBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });
        
        stakeAmountInput.addEventListener('input', () => {
            stakeBtn.disabled = true;
            stakeBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });

        approveDepositBtn.addEventListener('click', handleApproveDeposit);
        depositBtn.addEventListener('click', handleDeposit);
        vaultClaimYieldBtn.addEventListener('click', handleVaultClaim);
        vaultCompoundYieldBtn.addEventListener('click', handleVaultCompound);
        vaultWithdrawAllBtn.addEventListener('click', handleVaultWithdraw);
        
        claimStakingYieldBtn.addEventListener('click', handleStakingClaim);
        approveStakeBtn.addEventListener('click', handleApproveStake);
        stakeBtn.addEventListener('click', handleStakeSrv);
        unstakeBtn.addEventListener('click', handleUnstakeSrv);
        
    });
  </script>
</body>
</html>
