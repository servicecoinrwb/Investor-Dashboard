<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Investor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script defer src="abi.js"></script>
  <script defer src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white font-sans">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Investor Dashboard</h1>

    <div class="bg-gray-800 p-4 rounded mb-4">
      <p><strong>Wallet:</strong> <span id="wallet">-</span></p>
      <p class="text-sm text-gray-400">View your verified holdings, staking receipts, and redemption timeline.</p>
    </div>

    <div class="flex gap-4 mb-4">
      <div class="bg-gray-800 p-4 rounded flex-1">
        <p class="text-lg font-bold">SREV Balance</p>
        <p id="srev-balance" class="text-2xl font-mono">0.00</p>
        <p class="text-sm text-gray-400">Auto-yielding USDC receipt</p>
      </div>
      <div class="bg-gray-800 p-4 rounded flex-1">
        <p class="text-lg font-bold">LeaseToken_2025</p>
        <p id="lease-token" class="text-2xl font-mono">0</p>
        <p class="text-sm text-gray-400">$12 redeemable after maturity</p>
      </div>
    </div>

    <div class="bg-gray-800 p-4 rounded mb-4">
      <p class="text-lg font-bold">USDC Yield Pool</p>
      <p class="text-sm">Pool Balance: <span id="reward-pool">0.00 USDC</span></p>
      <p class="text-sm">Your Pending Rewards: <span id="pending-rewards">0.00 USDC</span></p>
    </div>

    <div class="flex flex-wrap gap-2">
      <button id="claim" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Claim Yield</button>
      <button id="stake" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Stake SRV</button>
      <button id="unstake" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">Unstake SRV</button>
      <button id="redeemLeaseToken" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Redeem LeaseToken</button>
      <button id="earlyRedeem" class="bg-white text-black font-bold py-2 px-4 rounded">Early Redeem</button>
      <button id="buyLeaseToken" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">Buy LeaseToken</button>
    </div>
  </div>

  <script>
    const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    let signer;
    const usdcAddress = "0xaf88d065e77c8cC2239327C5EDb3A432268e5831";

    async function init() {
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      const user = await signer.getAddress();
      document.getElementById("wallet").innerText = user;

      const srev = new ethers.Contract("0x2F745Da2FA453ee76c756fADcc081f59284B2a40", srevAbi, provider);
      const lease = new ethers.Contract("0xd0dc6eeE2dD77d7A4C09108993d0c7ad6a0b60E3", leaseBondAbi, provider);
      const reward = new ethers.Contract("0x71f618EFb0422687e5B2ad9cD973aDACb645D9DE", rewardAbi, provider);

      const srevBal = await srev.balanceOf(user);
      document.getElementById("srev-balance").innerText = (srevBal / 1e18).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

      const leaseBal = await lease.balanceOf(user);
      document.getElementById("lease-token").innerText = leaseBal.toString();

      const pool = await reward.viewRewardPoolBalance();
      const pending = await reward.viewPending(user);
      document.getElementById("reward-pool").innerText = (pool / 1e6).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " USDC";
      document.getElementById("pending-rewards").innerText = (pending / 1e6).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " USDC";
    }

    window.addEventListener("load", init);

    document.getElementById("buyLeaseToken").addEventListener("click", async () => {
      if (!signer) return alert("Connect wallet first");
      const leaseBond = new ethers.Contract("0xd0dc6eeE2dD77d7A4C09108993d0c7ad6a0b60E3", leaseBondAbi, signer);
      const amount = prompt("Enter amount of USDC to spend:");
      if (!amount || isNaN(amount)) return;
      const usdc = new ethers.Contract(usdcAddress, erc20Abi, signer);
      await usdc.approve(leaseBond.address, ethers.utils.parseUnits(amount, 6));
      await leaseBond.buy(ethers.utils.parseUnits(amount, 6));
      alert("Lease token purchased!");
    });
  </script>
</body>
</html>
