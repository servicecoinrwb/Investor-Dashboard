<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Coin Ecosystem</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for the notification toast */
    #notification-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        transition: opacity 0.5s, transform 0.5s;
        opacity: 0;
        pointer-events: none;
        z-index: 100;
    }
    #notification-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
    }
  </style>
</head>
<body class="bg-black text-white font-sans">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Service Coin Ecosystem</h1>
    
    <div id="connect-wallet-container" class="text-center bg-gray-800 p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4">Connect Your Wallet</h2>
        <p id="wallet-instructions" class="text-gray-400 mb-6">Please connect your wallet to view the dashboard.</p>
        <button id="connect-wallet-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors text-lg">Connect Wallet</button>
    </div>

    <div id="dashboard-content" class="hidden">
        <!-- Wallet Info (Full Width) -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-md">
          <p><strong>Wallet:</strong> <span id="wallet">-</span></p>
          <p class="text-sm text-gray-400">View your verified holdings, staking receipts, and redemption timeline.</p>
        </div>

        <!-- Main Two-Column Layout -->
        <div class="grid lg:grid-cols-5 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Balances -->
                <div class="grid md:grid-cols-2 gap-4">
                  <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <p class="text-lg font-bold">SREV Balance</p>
                    <p id="srev-balance" class="text-2xl font-mono">0.00</p>
                    <p class="text-sm text-gray-400">Auto-yielding USDC receipt</p>
                  </div>
                  <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <p class="text-lg font-bold">PFLOW25</p>
                    <p id="lease-token" class="text-2xl font-mono">0</p>
                    <p class="text-sm text-gray-400">$10 Buy 10.80 Early Redeem after Cooldown period $12 redeemable after maturity</p>
                  </div>
                </div>

                <!-- Staking and LeaseToken Actions -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">SRV Staking & PFLOW25</h3>
                    <div class="flex flex-wrap gap-2">
                      <button id="claim" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Claim Yield (Staking)</button>
                      <button id="stake" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Stake SRV</button>
                      <button id="unstake" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Unstake SRV</button>
                      <button id="redeemLeaseToken" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Redeem PFLOW25</button>
                      <button id="earlyRedeem" class="bg-white text-black font-bold py-2 px-4 rounded-lg transition-colors">Early Redeem</button>
                      <button id="buyLeaseToken" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Buy PFLOW25</button>
                    </div>
                </div>
                
                <!-- Investor Vault Actions -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Real Yield System</h3>
                    
                    <div class="mb-6 border-b border-gray-700 pb-6">
                        <label for="deposit-amount" class="block text-sm font-medium text-gray-300 mb-2">Deposit USDC to Real Yield System</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="deposit-amount" placeholder="USDC Amount" class="bg-gray-900 border border-gray-700 text-white rounded-lg p-2 flex-grow focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <button id="approve-deposit-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Approve</button>
                            <button id="deposit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>Deposit</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">First approve, then deposit.</p>
                    </div>
            
                    <div class="flex flex-wrap gap-2">
                        <button id="vault-claim-yield-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Claim Yield</button>
                        <button id="vault-compound-yield-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Compound Yield</button>
                        <button id="vault-withdraw-all-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Withdraw All</button>
                    </div>
                </div>
                 <!-- Vault Claimable Yield -->
                 <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <p class="text-lg font-bold">Real Yield System Reward</p>
                    <p id="vault-claimable-yield" class="text-2xl font-mono">0.00</p>
                    <p class="text-sm text-gray-400">USDC earned in vault</p>
                  </div>
            </div>
            <!-- Right Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Platform Totals -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Platform Totals</h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Real Yield System Balance</p>
                            <p id="platform-investor-vault-balance" class="text-lg font-mono">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Total Capital Deposited</p>
                            <p id="platform-total-deposited" class="text-lg font-mono">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Solver Yield Balance</p>
                            <p id="platform-yield-vault-balance" class="text-lg font-mono">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Total Fees Processed</p>
                            <p id="platform-total-fees" class="text-lg font-mono">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Yield Pool -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                  <p class="text-lg font-bold">Staking Yield Pool</p>
                  <p class="text-sm">Pool Balance: <span id="reward-pool">0.00 USDC</span></p>
                  <p class="text-sm">Your Pending Rewards: <span id="pending-rewards">0.00 USDC</span></p>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="notification-toast" class="px-4 py-2 rounded-lg shadow-lg text-white">
      <span id="notification-message"></span>
  </div>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- ABIs and Contract Addresses ---
        const srevAbi = [{"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"}];
        const leaseBondAbi = [
          {"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"},
          {"inputs":[{"name":"amount","type":"uint256"}],"name":"buy","outputs":[],"stateMutability":"nonpayable","type":"function"},
          {"inputs":[],"name":"redeem","outputs":[],"stateMutability":"nonpayable","type":"function"},
          {"inputs":[],"name":"earlyRedeem","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];
        const rewardAbi = [
          {"inputs":[],"name":"viewRewardPoolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
          {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"viewPending","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
          {"inputs":[],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},
          {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},
          {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];
        const erc20Abi = [
          "function approve(address spender, uint256 amount) external returns (bool)",
          "function balanceOf(address owner) view returns (uint256)",
          "function allowance(address owner, address spender) view returns (uint256)"
        ];
        const investorVaultAbi = [{"inputs":[{"internalType":"address","name":"_usdc","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharesMinted","type":"uint256"}],"name":"Deposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldKernel","type":"address"},{"indexed":true,"internalType":"address","name":"newKernel","type":"address"}],"name":"KernelUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharesBurned","type":"uint256"}],"name":"Withdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"YieldClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"investor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newShares","type":"uint256"}],"name":"YieldCompounded","type":"event"},{"inputs":[],"name":"LOCKUP_PERIOD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"investors","type":"address[]"}],"name":"batchClaimYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"investors","type":"address[]"}],"name":"batchWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"investor","type":"address"}],"name":"claimableYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"claimedYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"compoundYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"deposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"depositTimestamps","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fundKernel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"investor","type":"address"}],"name":"getInvestorInfo","outputs":[{"internalType":"uint256","name":"share","type":"uint256"},{"internalType":"uint256","name":"claimable","type":"uint256"},{"internalType":"uint256","name":"claimed","type":"uint256"},{"internalType":"uint256","name":"unlockTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVaultTotals","outputs":[{"internalType":"uint256","name":"totalUSDC","type":"uint256"},{"internalType":"uint256","name":"totalSharesMinted","type":"uint256"},{"internalType":"uint256","name":"totalYield","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"kernel","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"receiveYield","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_kernel","type":"address"}],"name":"setKernel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"shares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalDeposits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalYieldDistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdc","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shareAmount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const yieldVaultAbi = [{"inputs":[{"internalType":"address","name":"_governance","type":"address"},{"internalType":"address","name":"_kernel","type":"address"},{"internalType":"address","name":"_feeToken","type":"address"},{"internalType":"address","name":"_daoTreasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldTreasury","type":"address"},{"indexed":true,"internalType":"address","name":"newTreasury","type":"address"}],"name":"DaoTreasuryUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"fromKernel","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesDepositedInVault","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"treasury","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesSweptToTreasury","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldKernel","type":"address"},{"indexed":true,"internalType":"address","name":"newKernel","type":"address"}],"name":"KernelAddressUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"inputs":[],"name":"daoTreasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalFeesAccumulatedInVault","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getVaultBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"kernelAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"recordFeeDeposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newTreasury","type":"address"}],"name":"setDaoTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newKernel","type":"address"}],"name":"setKernelAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"sweepFullBalanceToTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"sweepToTreasury","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalFeesAccumulatedInVault","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        const usdcAddress = "0xaf88d065e77c8cC2239327C5EDb3A432268e5831";
        const srevAddress = "0x2F745Da2FA453ee76c756fADcc081f59284B2a40";
        const leaseAddress = "0xd0dc6eeE2dD77d7A4C09108993d0c7ad6a0b60E3";
        const rewardAddress = "0x71f618EFb0422687e5B2ad9cD973aDACb645D9DE";
        const investorVaultAddress = "0x1a51f1966d35661573908DC913307076d937aa90";
        const yieldVaultAddress = "0x44D64E1B9dC5F90b389900Da24B8de631222432C";

        // --- Ethers.js Setup ---
        let provider;
        let signer;

        // --- UI Elements ---
        const walletEl = document.getElementById("wallet");
        const srevBalanceEl = document.getElementById("srev-balance");
        const leaseTokenEl = document.getElementById("lease-token");
        const rewardPoolEl = document.getElementById("reward-pool");
        const pendingRewardsEl = document.getElementById("pending-rewards");
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        const connectWalletContainer = document.getElementById('connect-wallet-container');
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const walletInstructions = document.getElementById('wallet-instructions');
        const dashboardContent = document.getElementById('dashboard-content');
        const vaultClaimableYieldEl = document.getElementById('vault-claimable-yield');

        const depositAmountInput = document.getElementById('deposit-amount');
        const approveDepositBtn = document.getElementById('approve-deposit-btn');
        const depositBtn = document.getElementById('deposit-btn');
        const vaultClaimYieldBtn = document.getElementById('vault-claim-yield-btn');
        const vaultCompoundYieldBtn = document.getElementById('vault-compound-yield-btn');
        const vaultWithdrawAllBtn = document.getElementById('vault-withdraw-all-btn');
        
        const claimBtn = document.getElementById('claim');
        const stakeBtn = document.getElementById('stake');
        const unstakeBtn = document.getElementById('unstake');
        const redeemLeaseTokenBtn = document.getElementById('redeemLeaseToken');
        const earlyRedeemBtn = document.getElementById('earlyRedeem');
        const buyLeaseTokenBtn = document.getElementById('buyLeaseToken');

        // Platform Totals UI Elements
        const platformInvestorVaultBalanceEl = document.getElementById('platform-investor-vault-balance');
        const platformTotalDepositedEl = document.getElementById('platform-total-deposited');
        const platformYieldVaultBalanceEl = document.getElementById('platform-yield-vault-balance');
        const platformTotalFeesEl = document.getElementById('platform-total-fees');


        // --- Helper Functions ---
        function showNotification(message, isError = false) {
            notificationMessage.textContent = message;
            notificationToast.className = `px-4 py-2 rounded-lg shadow-lg text-white ${isError ? 'bg-red-600' : 'bg-gray-700'}`;
            notificationToast.classList.add('show');
            setTimeout(() => { notificationToast.classList.remove('show'); }, 3000);
        }

        function formatCurrency(value) {
            return `$${parseFloat(value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // --- Core Application Logic ---
        async function connectAndLoadDashboard() {
          try {
            provider = new ethers.providers.Web3Provider(window.ethereum, "any");
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const user = await signer.getAddress();
            walletEl.innerText = `${user.substring(0, 6)}...${user.substring(user.length - 4)}`;

            const srev = new ethers.Contract(srevAddress, srevAbi, provider);
            const lease = new ethers.Contract(leaseAddress, leaseBondAbi, provider);
            const reward = new ethers.Contract(rewardAddress, rewardAbi, provider);
            const investorVault = new ethers.Contract(investorVaultAddress, investorVaultAbi, provider);
            const yieldVault = new ethers.Contract(yieldVaultAddress, yieldVaultAbi, provider);

            const [
                srevBal, 
                leaseBal, 
                pool, 
                pending, 
                vaultYield,
                investorVaultTotals,
                totalCapitalDeposited,
                yieldVaultBalance,
                totalFees
            ] = await Promise.all([
                srev.balanceOf(user),
                lease.balanceOf(user),
                reward.viewRewardPoolBalance(),
                reward.viewPending(user),
                investorVault.claimableYield(user),
                investorVault.getVaultTotals(),
                investorVault.totalDeposits(),
                yieldVault.getVaultBalance(),
                yieldVault.totalFeesAccumulatedInVault()
            ]);
            
            srevBalanceEl.innerText = parseFloat(ethers.utils.formatUnits(srevBal, 18)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            leaseTokenEl.innerText = leaseBal.toString();
            rewardPoolEl.innerText = `${parseFloat(ethers.utils.formatUnits(pool, 6)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} USDC`;
            pendingRewardsEl.innerText = `${parseFloat(ethers.utils.formatUnits(pending, 18)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} USDC`;
            vaultClaimableYieldEl.innerText = parseFloat(ethers.utils.formatUnits(vaultYield, 6)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Populate Platform Totals
            platformInvestorVaultBalanceEl.innerText = formatCurrency(ethers.utils.formatUnits(investorVaultTotals.totalUSDC, 6));
            platformTotalDepositedEl.innerText = formatCurrency(ethers.utils.formatUnits(totalCapitalDeposited, 6));
            platformYieldVaultBalanceEl.innerText = formatCurrency(ethers.utils.formatUnits(yieldVaultBalance, 6));
            platformTotalFeesEl.innerText = formatCurrency(ethers.utils.formatUnits(totalFees, 6));


            connectWalletContainer.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
          } catch (error) {
            console.error("Connection/data fetch failed:", error);
            showNotification("Failed to connect to wallet or fetch data.", true);
          }
        }
        
        // --- Action Handlers ---
        async function handleApproveDeposit() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = depositAmountInput.value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return showNotification("Please enter a valid amount.", true);
            }
            try {
                const usdc = new ethers.Contract(usdcAddress, erc20Abi, signer);
                showNotification("Approving USDC spend...");
                const tx = await usdc.approve(investorVaultAddress, ethers.utils.parseUnits(amount, 6));
                await tx.wait();
                showNotification("Approval successful! You can now deposit.", false);
                depositBtn.disabled = false;
                depositBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } catch (error) {
                console.error("Approval failed:", error);
                showNotification(error.reason || "Approval failed.", true);
            }
        }
        
        async function handleDeposit() {
             if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = depositAmountInput.value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return showNotification("Please enter a valid amount.", true);
            }
            try {
                const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
                showNotification("Depositing USDC...");
                const tx = await vault.deposit(ethers.utils.parseUnits(amount, 6));
                await tx.wait();
                showNotification("Deposit successful!", false);
                depositAmountInput.value = ""; 
                depositBtn.disabled = true; 
                depositBtn.classList.add('opacity-50', 'cursor-not-allowed');
                connectAndLoadDashboard();
            } catch(error) {
                console.error("Deposit failed:", error);
                showNotification(error.reason || "Deposit failed.", true);
            }
        }

        async function handleVaultClaim() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
             try {
                const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
                showNotification("Claiming yield...");
                const tx = await vault.claimYield();
                await tx.wait();
                showNotification("Yield claimed!", false);
                connectAndLoadDashboard();
            } catch(error) {
                console.error("Claim failed:", error);
                showNotification(error.reason || "Claim failed.", true);
            }
        }

        async function handleVaultCompound() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
             try {
                const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
                showNotification("Compounding yield...");
                const tx = await vault.compoundYield();
                await tx.wait();
                showNotification("Yield compounded!", false);
                connectAndLoadDashboard();
            } catch(error) {
                console.error("Compound failed:", error);
                showNotification(error.reason || "Compound failed.", true);
            }
        }

        async function handleVaultWithdraw() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
             try {
                const vault = new ethers.Contract(investorVaultAddress, investorVaultAbi, signer);
                const user = await signer.getAddress();
                
                showNotification("Fetching your shares to withdraw...");
                const userShares = await vault.shares(user);

                if (userShares.isZero()) {
                    return showNotification("You have no shares to withdraw.", true);
                }

                showNotification("Withdrawing all funds...");
                const tx = await vault.withdraw(userShares);
                await tx.wait();
                showNotification("Withdrawal successful!", false);
                connectAndLoadDashboard();
            } catch(error) {
                console.error("Withdrawal failed:", error);
                showNotification(error.reason || "Withdrawal failed.", true);
            }
        }

        async function handleBuyLeaseToken() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = prompt("Enter amount of USDC to spend:");
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                if (amount !== null) showNotification("Invalid amount entered.", true);
                return;
            }
            try {
              const leaseBond = new ethers.Contract(leaseAddress, leaseBondAbi, signer);
              const usdc = new ethers.Contract(usdcAddress, erc20Abi, signer);
              showNotification("Approving USDC spend...");
              const txApprove = await usdc.approve(leaseBond.address, ethers.utils.parseUnits(amount, 6));
              await txApprove.wait(); 
              showNotification("Processing purchase...");
              const txBuy = await leaseBond.buy(ethers.utils.parseUnits(amount, 6));
              await txBuy.wait();
              showNotification("Lease token purchased successfully!");
              connectAndLoadDashboard(); 
            } catch (error) {
              console.error("Purchase failed:", error);
              showNotification(error.reason || "Purchase transaction failed.", true);
            }
        }

        async function handleStakingClaim() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            try {
                const rewardContract = new ethers.Contract(rewardAddress, rewardAbi, signer);
                showNotification("Claiming staking rewards...");
                const tx = await rewardContract.claim();
                await tx.wait();
                showNotification("Staking rewards claimed!", false);
                connectAndLoadDashboard();
            } catch (error) {
                console.error("Staking claim failed:", error);
                showNotification(error.reason || "Staking claim failed. Check contract ABI.", true);
            }
        }

        async function handleStakeSrv() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = prompt("Enter amount of SREV to stake:");
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                if (amount !== null) showNotification("Invalid amount entered.", true);
                return;
            }
            try {
                const srevContract = new ethers.Contract(srevAddress, erc20Abi, signer);
                showNotification("Approving SREV for staking...");
                const txApprove = await srevContract.approve(rewardAddress, ethers.utils.parseUnits(amount, 18));
                await txApprove.wait();
                
                showNotification("Staking SREV...");
                const rewardContract = new ethers.Contract(rewardAddress, rewardAbi, signer);
                const txStake = await rewardContract.stake(ethers.utils.parseUnits(amount, 18));
                await txStake.wait();

                showNotification("SREV staked successfully!", false);
                connectAndLoadDashboard();
            } catch (error) {
                console.error("Stake SRV failed:", error);
                showNotification(error.reason || "Stake SRV failed. Check contract ABI.", true);
            }
        }

        async function handleUnstakeSrv() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            const amount = prompt("Enter amount of SREV to unstake:");
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                if (amount !== null) showNotification("Invalid amount entered.", true);
                return;
            }
            try {
                const rewardContract = new ethers.Contract(rewardAddress, rewardAbi, signer);
                showNotification("Unstaking SREV...");
                const tx = await rewardContract.unstake(ethers.utils.parseUnits(amount, 18));
                await tx.wait();
                showNotification("SREV unstaked successfully!", false);
                connectAndLoadDashboard();
            } catch (error) {
                console.error("Unstake SRV failed:", error);
                showNotification(error.reason || "Unstake SRV failed. Check contract ABI.", true);
            }
        }

        async function handleRedeemLeaseToken() {
             if (!signer) return showNotification("Please connect your wallet first.", true);
            try {
                const leaseContract = new ethers.Contract(leaseAddress, leaseBondAbi, signer);
                showNotification("Redeeming PFLOW25...");
                const tx = await leaseContract.redeem();
                await tx.wait();
                showNotification("PFLOW25 redeemed successfully!", false);
                connectAndLoadDashboard();
            } catch (error) {
                console.error("Redeem PFLOW25 failed:", error);
                showNotification(error.reason || "Redeem failed. Check contract ABI.", true);
            }
        }

        async function handleEarlyRedeem() {
            if (!signer) return showNotification("Please connect your wallet first.", true);
            try {
                const leaseContract = new ethers.Contract(leaseAddress, leaseBondAbi, signer);
                showNotification("Executing early redeem...");
                const tx = await leaseContract.earlyRedeem();
                await tx.wait();
                showNotification("Early redeem successful!", false);
                connectAndLoadDashboard();
            } catch (error) {
                console.error("Early redeem failed:", error);
                showNotification(error.reason || "Early redeem failed. Check contract ABI.", true);
            }
        }


        // --- Event Listeners Setup ---
        connectWalletBtn.addEventListener('click', () => {
            if (typeof window.ethereum !== 'undefined') {
                connectAndLoadDashboard();
            } else {
                showNotification("No wallet detected. Please install MetaMask.", true);
                walletInstructions.textContent = "No web3 wallet detected. Please install a wallet like MetaMask to continue.";
                connectWalletBtn.textContent = "Install MetaMask";
                connectWalletBtn.onclick = () => { window.open("https://metamask.io/download/", "_blank"); };
            }
        });
        
        depositAmountInput.addEventListener('input', () => {
            depositBtn.disabled = true;
            depositBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });

        approveDepositBtn.addEventListener('click', handleApproveDeposit);
        depositBtn.addEventListener('click', handleDeposit);
        vaultClaimYieldBtn.addEventListener('click', handleVaultClaim);
        vaultCompoundYieldBtn.addEventListener('click', handleVaultCompound);
        vaultWithdrawAllBtn.addEventListener('click', handleVaultWithdraw);
        
        buyLeaseTokenBtn.addEventListener('click', handleBuyLeaseToken);
        claimBtn.addEventListener('click', handleStakingClaim);
        stakeBtn.addEventListener('click', handleStakeSrv);
        unstakeBtn.addEventListener('click', handleUnstakeSrv);
        redeemLeaseTokenBtn.addEventListener('click', handleRedeemLeaseToken);
        earlyRedeemBtn.addEventListener('click', handleEarlyRedeem);

    });
  </script>
</body>
</ht
