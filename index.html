<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Revenue</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.10.0/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #F5E6D3 0%, #E8D5C4 100%);
            min-height: 100vh;
            color: #2C3E50;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #FF6B35;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }

        .nav-links a {
            text-decoration: none;
            color: #2C3E50;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #FF6B35;
        }

        .wallet-connect {
            background: #FF6B35;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wallet-connect:hover {
            background: #E55A2B;
            transform: translateY(-2px);
        }

        .wallet-connect.disconnected {
            background: #7F8C8D;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 50px;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: bold;
            color: #2C3E50;
            margin-bottom: 15px;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: #7F8C8D;
            max-width: 600px;
            margin: 0 auto;
        }

        .connection-status {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .connection-status.connected {
            background: linear-gradient(135deg, #27AE60, #2ECC71);
            color: white;
        }

        .connection-status.disconnected {
            background: linear-gradient(135deg, #E74C3C, #EC7063);
            color: white;
        }

        .stats-banner {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            color: #FF6B35;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #7F8C8D;
            font-weight: 500;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .wallet-info {
            background: linear-gradient(135deg, #FF6B35, #E55A2B);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(255, 107, 53, 0.3);
        }

        .wallet-address {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .wallet-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .balance-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .balance-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .balance-card:hover {
            border-color: #FF6B35;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FF6B35;
            margin-bottom: 8px;
        }

        .balance-label {
            color: #7F8C8D;
            font-weight: 500;
        }

        .balance-description {
            color: #95A5A6;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .staking-interface {
            margin-bottom: 30px;
        }

        .staking-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2C3E50;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #E8D5C4;
            border-radius: 10px;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #FF6B35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary {
            background: #FF6B35;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #E55A2B;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.3);
        }

        .btn-secondary {
            background: #3498DB;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #2980B9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: #27AE60;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-warning {
            background: #F39C12;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #E67E22;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);
        }

        .apr-display {
            background: linear-gradient(135deg, #27AE60, #2ECC71);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .apr-rate {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .apr-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .transaction-history {
            margin-top: 30px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #FF6B35;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-type {
            font-weight: 600;
            color: #2C3E50;
        }

        .transaction-amount {
            font-weight: bold;
            color: #FF6B35;
        }

        .transaction-time {
            font-size: 0.85rem;
            color: #7F8C8D;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            height: fit-content;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #7F8C8D;
            font-weight: 500;
        }

        .metric-value {
            font-weight: 600;
            color: #2C3E50;
        }

        .contract-info {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498DB;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .contract-address {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            color: #2C3E50;
        }

        .error-message {
            background: #E74C3C;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #27AE60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .max-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #FF6B35;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .input-container {
            position: relative;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .hero-title {
                font-size: 2rem;
            }
            
            .stats-banner {
                grid-template-columns: 1fr 1fr;
            }
            
            .balance-section,
            .staking-controls {
                grid-template-columns: 1fr;
            }
            
            .contract-info > div {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
        }

        .icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">SERVICE COIN</div>
            <ul class="nav-links">
                <li><a href="#" class="active">Dashboard</a></li>
                <li><a href="#">Staking</a></li>
                <li><a href="#">Analytics</a></li>
                <li><a href="#">Governance</a></li>
                <li><a href="#">Docs</a></li>
            </ul>
            <button id="connectWallet" class="wallet-connect disconnected">Connect Wallet</button>
        </div>
    </nav>

    <div class="container">
        <div class="hero-section">
            <h1 class="hero-title">Service Revenue</h1>
            <p class="hero-subtitle">Deflationary, revenue-backed cryptocurrency powered by real-world businesses and sustainable yield generation</p>
            <div style="background: rgba(39, 174, 96, 0.1); border: 1px solid #27AE60; border-radius: 10px; padding: 15px; margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
                <div style="color: #27AE60; font-weight: 600; margin-bottom: 5px;">üü¢ Live on Blockchain</div>
                <div style="color: #2C3E50; font-size: 0.9rem;">Connected to deployed Service Revenue contracts. All transactions are real and recorded on the blockchain.</div>
            </div>
        </div>

        <div id="connectionStatus" class="connection-status disconnected">
            <h3>üîå Wallet Not Connected</h3>
            <p>Please connect your wallet to access the staking features</p>
        </div>

        <div class="stats-banner">
            <div class="stat-card">
                <div class="stat-number" id="totalStaked">Loading...</div>
                <div class="stat-label">Total SRV Staked</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="aprDisplay">5%</div>
                <div class="stat-label">Live APR Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rewardPoolStat">$0</div>
                <div class="stat-label">Business Revenue Pool</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="userStaked">0</div>
                <div class="stat-label">Your Staked Amount</div>
            </div>
        </div>

        <div id="walletInfo" class="wallet-info" style="display: none;">
            <div class="wallet-address" id="walletAddress">Not connected</div>
            <div class="wallet-status">
                <span id="networkStatus">Disconnected</span>
                <span class="status-badge" id="statusBadge">‚ùå Disconnected</span>
            </div>
        </div>

        <div class="main-grid">
            <div class="main-content">

                <div class="contract-info">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>üîí Staking Contract:</strong>
                            <div class="contract-address" id="stakingContractAddress">Loading...</div>
                        </div>
                        <div>
                            <strong>üéØ SREV Token:</strong>
                            <div class="contract-address" id="srevContractAddress">Loading...</div>
                        </div>
                        <div>
                            <strong>üí∞ Rewards Contract:</strong>
                            <div class="contract-address" id="rewardsContractDisplayAddress">Loading...</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: #7F8C8D;">
                        ‚úÖ All contracts are deployed and verified on the blockchain
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <div class="balance-section">
                    <div class="balance-card">
                        <div class="balance-amount" id="srvBalance">0</div>
                        <div class="balance-label">SRV Balance</div>
                        <div class="balance-description">Available for staking</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-amount" id="stakedAmount">0</div>
                        <div class="balance-label">Currently Staked</div>
                        <div class="balance-description">SRV tokens earning rewards</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                        SRV Staking Interface
                    </div>
                    
                    <div class="apr-display">
                        <div class="apr-rate" id="currentAPR">5% APR</div>
                        <div class="apr-label">Current Annual Percentage Rate</div>
                    </div>

                    <div class="staking-interface">
                        <div class="staking-controls">
                            <div>
                                <div class="input-group">
                                    <label class="input-label">Stake Amount</label>
                                    <div class="input-container">
                                        <input type="text" class="input-field" id="stakeAmount" placeholder="Enter SRV amount">
                                        <button class="max-button" onclick="setMaxStake()">MAX</button>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" id="approveBtn" onclick="approveTokens()" style="display: none;">Approve SRV</button>
                                <button class="btn btn-primary" id="stakeBtn" onclick="stakeTokens()" style="margin-top: 10px;" disabled>Stake SRV</button>
                            </div>
                            <div>
                                <div class="input-group">
                                    <label class="input-label">Unstake Amount</label>
                                    <div class="input-container">
                                        <input type="text" class="input-field" id="unstakeAmount" placeholder="Enter SRV amount">
                                        <button class="max-button" onclick="setMaxUnstake()">MAX</button>
                                    </div>
                                </div>
                                <button class="btn btn-warning" id="unstakeBtn" onclick="unstakeTokens()">Unstake SRV</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" id="businessRevenue">
                    <div class="card-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/>
                        </svg>
                        Business Revenue Rewards
                    </div>
                    <div class="balance-card" style="margin-bottom: 20px;">
                        <div class="balance-amount" id="rewardPoolBalance">$0.00</div>
                        <div class="balance-label">Total Reward Pool</div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Your Pending Rewards</span>
                        <span class="metric-value" id="pendingRewards">$0.00</span>
                    </div>
                    <div class="metric-item" style="border-bottom: none; padding-bottom: 20px;">
                        <span class="metric-label">Claim Status</span>
                        <span class="metric-value" id="claimCooldownStatus">Loading...</span>
                    </div>
                    <button class="btn btn-success" id="claimRewardsBtn" onclick="claimRewards()" disabled>Claim Rewards</button>
                </div>

                <div class="card">
                    <div class="card-title">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                        SRV Token Features
                    </div>
                    
                    <div class="balance-section" style="margin-bottom: 20px;">
                        <div class="balance-card">
                            <div class="balance-amount" id="isReflectionToken">Loading...</div>
                            <div class="balance-label">Reflection Token</div>
                            <div class="balance-description">Redistributes tokens to holders</div>
                        </div>
                        <div class="balance-card">
                            <div class="balance-amount" id="totalFeesCollected">0</div>
                            <div class="balance-label">Total Fees Collected</div>
                            <div class="balance-description">Lifetime fee accumulation</div>
                        </div>
                    </div>
                    
                    <div class="metric-item">
                        <span class="metric-label">Transfer Fee</span>
                        <span class="metric-value" id="transferFee">0.00%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Burn Fee</span>
                        <span class="metric-value" id="burnFee">0.00%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Reflection Fee</span>
                        <span class="metric-value" id="reflectionFee">0.00%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Buyback Fee</span>
                        <span class="metric-value" id="buybackFee">0.00%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Max Supply</span>
                        <span class="metric-value" id="maxSupply">Loading...</span>
                    </div>
                    <div class="metric-item" style="border-bottom: none;">
                        <span class="metric-label">Treasury</span>
                        <span class="metric-value" id="treasuryAddress">Loading...</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z"/></svg>
                        SREV Token Details
                    </div>
                    
                    <div class="balance-section" style="margin-bottom: 20px;">
                        <div class="balance-card">
                            <div class="balance-amount" id="srevUserBalance">0</div>
                            <div class="balance-label">Your SREV Balance</div>
                            <div class="balance-description">Receipt tokens from staking</div>
                        </div>
                        <div class="balance-card">
                            <div class="balance-amount" id="srevSupply">0</div>
                            <div class="balance-label">Total SREV Supply</div>
                            <div class="balance-description">All minted receipt tokens</div>
                        </div>
                    </div>
                    
                    <div class="metric-item">
                        <span class="metric-label">Token Name</span>
                        <span class="metric-value" id="srevTokenName">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Token Symbol</span>
                        <span class="metric-value" id="srevTokenSymbol">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Decimals</span>
                        <span class="metric-value" id="srevDecimals">18</span>
                    </div>
                    <div class="metric-item" style="border-bottom: none;">
                        <span class="metric-label">Backing Ratio</span>
                        <span class="metric-value" id="backingRatio">1:1</span>
                    </div>
                </div>

                <div class="card transaction-history">
                    <div class="card-title">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M3 12h18m-9-9l9 9-9 9"/></svg>
                        Recent Transactions
                    </div>
                    <div id="transactionList">
                        <p style="text-align: center; color: #7F8C8D; padding: 20px;">No transactions yet. Connect your wallet to get started!</p>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="info-panel">
                    <div class="card-title">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M9 17H7v-7h2m0-4H7v2h2m6-2h-2v11h2m0-4h-2v2h2"/></svg>
                        Portfolio Analytics
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">SRV Balance</span>
                        <span class="metric-value" id="sidebarSrvBalance">0</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">SREV Balance</span>
                        <span class="metric-value" id="sidebarSrevBalance">0</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Total Staked</span>
                        <span class="metric-value" id="sidebarStaked">0</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Pending Rewards</span>
                        <span class="metric-value" id="pendingRewardsSidebar">$0.00</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Network</span>
                        <span class="metric-value" id="networkName">Not connected</span>
                    </div>
                </div>

                <div class="info-panel" style="margin-top: 20px;">
                    <div class="card-title">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        Contract Information
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">SRV Token</span>
                        <span class="metric-value" id="srvTokenAddress">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">SREV Token</span>
                        <span class="metric-value" id="srevTokenAddress">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Staking Vault</span>
                        <span class="metric-value" id="stakingVaultAddress">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Rewards Contract</span>
                        <span class="metric-value" id="rewardsContractAddress">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Reward Token</span>
                        <span class="metric-value" id="rewardTokenAddress">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Gas Price</span>
                        <span class="metric-value" id="gasPrice">-- gwei</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration - Live Service Revenue Contracts
        const SRV_TOKEN_ADDRESS = '0x057ba66c2109Fd4487F0781E0203B71fd77a6341';
        const SREV_TOKEN_ADDRESS = '0x2F745Da2FA453ee76c756fADcc081f59284B2a40';
        const STAKING_CONTRACT_ADDRESS = '0x691e29E98ECDc5ae948355F30102cD4D637eddB7';
        const REWARDS_CONTRACT_ADDRESS = '0x71f618EFb0422687e5B2ad9cD973aDACb645D9DE';
        
        const STAKING_ABI = [
            {"inputs":[{"internalType":"address","name":"_srv","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[],"name":"SREV","outputs":[{"internalType":"contract SREVToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"SRV","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getSREV","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"staked","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        const SREV_ABI = [
            {"inputs":[{"internalType":"address","name":"_stakingVault","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},
            {"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"stakingVault","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}
        ];

        const REWARDS_ABI = [
            {"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"},{"internalType":"address","name":"_srevToken","type":"address"},{"internalType":"address","name":"_daoOperator","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newAPR","type":"uint256"}],"name":"APRUpdated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newInterval","type":"uint256"}],"name":"ClaimIntervalUpdated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Claimed","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdrawal","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"status","type":"bool"}],"name":"Paused","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardFunded","type":"event"},
            {"inputs":[],"name":"BPS_DIVISOR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"SECONDS_IN_YEAR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address[]","name":"users","type":"address[]"}],"name":"accrueAll","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"baseAPR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"claimInterval","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"daoOperator","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"to","type":"address"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fund","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastClaimTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastClaimed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"rewardToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"newAPR","type":"uint256"}],"name":"setBaseAPR","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"newInterval","type":"uint256"}],"name":"setClaimInterval","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"bool","name":"_paused","type":"bool"}],"name":"setPaused","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"srevToken","outputs":[{"internalType":"contract ISREVToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"viewClaimCooldown","outputs":[{"internalType":"uint256","name":"secondsUntilClaimable","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"viewPending","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"viewRewardPoolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];

        const SRV_ABI = [
            {"inputs":[{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"symbol","type":"string"},{"internalType":"string","name":"logo","type":"string"},{"internalType":"uint8","name":"decimals","type":"uint8"},{"internalType":"uint256","name":"initialSupply","type":"uint256"},{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"address","name":"treasury","type":"address"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"address","name":"tokenStore","type":"address"},{"components":[{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"transferFee","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"burn","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"reflection","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"buyback","type":"tuple"}],"internalType":"struct ITokenLauncherERC20.Fees","name":"fees","type":"tuple"},{"internalType":"address","name":"buybackHandler","type":"address"},{"internalType":"enum ITokenLauncherCommon.PaymentMethod","name":"paymentMethod","type":"uint8"}],"internalType":"struct ITokenLauncherERC20.CreateErc20Input","name":"_input","type":"tuple"}],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"fees","outputs":[{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"transferFee","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"burn","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"reflection","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"buyback","type":"tuple"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"isExcludedFromReflectionRewards","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"isExemptedFromTax","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"isReflectionToken","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"logo","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"maxSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tAmount","type":"uint256"}],"name":"reflect","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tAmount","type":"uint256"},{"internalType":"bool","name":"deductTransferFee","type":"bool"}],"name":"reflectionFromToken","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"rAmount","type":"uint256"}],"name":"tokenFromReflection","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalFees","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalReflection","outputs":[{"internalType":"uint256","name":"t","type":"uint256"},{"internalType":"uint256","name":"r","type":"uint256"},{"internalType":"uint256","name":"tFee","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}
        ];

        const ERC20_ABI = [
            {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":""}],"stateMutability":"view","type":"function"}
        ];

        // Global variables
        let web3;
        let userAccount;
        let stakingContract;
        let srvContract;
        let srevContract;
        let rewardsContract;
        let rewardTokenContract;
        let srvDecimals = 18;
        let srevDecimals = 18;
        let rewardTokenDecimals = 6; // USDC typically uses 6 decimals
        
        // Initialize the application
        async function init() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                
                try {
                    const accounts = await web3.eth.getAccounts();
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.error('Error checking for accounts:', error);
                }
                
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
            } else {
                showError('Please install MetaMask to use this application.');
            }
            
            document.getElementById('stakingContractAddress').textContent = STAKING_CONTRACT_ADDRESS;
            document.getElementById('srevContractAddress').textContent = SREV_TOKEN_ADDRESS;
            document.getElementById('rewardsContractDisplayAddress').textContent = REWARDS_CONTRACT_ADDRESS;
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask is not installed');
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                
                stakingContract = new web3.eth.Contract(STAKING_ABI, STAKING_CONTRACT_ADDRESS);
                rewardsContract = new web3.eth.Contract(REWARDS_ABI, REWARDS_CONTRACT_ADDRESS);
                srvContract = new web3.eth.Contract(SRV_ABI, SRV_TOKEN_ADDRESS);
                srevContract = new web3.eth.Contract(SREV_ABI, SREV_TOKEN_ADDRESS);
                
                const rewardTokenAddress = await rewardsContract.methods.rewardToken().call();
                rewardTokenContract = new web3.eth.Contract(ERC20_ABI, rewardTokenAddress);
                
                [srvDecimals, srevDecimals, rewardTokenDecimals] = await Promise.all([
                    srvContract.methods.decimals().call(),
                    srevContract.methods.decimals().call(),
                    rewardTokenContract.methods.decimals().call()
                ]);
                
                updateConnectionStatus(true);
                await loadGlobalData();
                await loadUserData();
                
                showSuccess('Wallet connected successfully!');
                
            } catch (error) {
                console.error('Connection error:', error);
                showError(`Failed to connect wallet: ${error.message}`);
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            userAccount = null;
            updateConnectionStatus(false);
        }

        // Update connection status UI
        async function updateConnectionStatus(connected) {
            const connectBtn = document.getElementById('connectWallet');
            const connectionStatus = document.getElementById('connectionStatus');
            const walletInfo = document.getElementById('walletInfo');
            
            if (connected && userAccount) {
                connectBtn.textContent = 'Disconnect';
                connectBtn.className = 'wallet-connect';
                connectBtn.onclick = disconnectWallet;
                
                connectionStatus.className = 'connection-status connected';
                connectionStatus.innerHTML = '<h3>‚úÖ Wallet Connected</h3><p>You can now stake and manage your SRV tokens</p>';
                
                walletInfo.style.display = 'block';
                document.getElementById('walletAddress').textContent = userAccount;
                
                const networkId = await web3.eth.net.getId();
                const networkName = { 1: 'Mainnet', 5: 'Goerli', 11155111: 'Sepolia' }[networkId] || 'Unknown Network';
                document.getElementById('networkStatus').textContent = `Connected to ${networkName}`;
                document.getElementById('statusBadge').textContent = '‚úì Connected';
                
            } else {
                connectBtn.textContent = 'Connect Wallet';
                connectBtn.className = 'wallet-connect disconnected';
                connectBtn.onclick = connectWallet;
                
                connectionStatus.className = 'connection-status disconnected';
                connectionStatus.innerHTML = '<h3>üîå Wallet Not Connected</h3><p>Please connect your wallet to access staking features</p>';
                
                walletInfo.style.display = 'none';
                resetUI();
            }
        }

        // Load data that is not user-specific
        async function loadGlobalData() {
            if (!srevContract) return;
            try {
                // Hardcoded APR
                const formattedAPR = '5.00%';
                document.getElementById('aprDisplay').textContent = formattedAPR;
                document.getElementById('currentAPR').textContent = formattedAPR + ' APR';

                const srevTotalSupply = await srevContract.methods.totalSupply().call();
                document.getElementById('totalStaked').textContent = formatTokenAmount(srevTotalSupply, srvDecimals) + ' SRV';

                // Load SRV Token Features
                if (srvContract) {
                    const [isReflection, totalFees, feeStructure, maxSupply, treasury] = await Promise.all([
                        srvContract.methods.isReflectionToken().call(),
                        srvContract.methods.totalFees().call(),
                        srvContract.methods.fees().call(),
                        srvContract.methods.maxSupply().call(),
                        srvContract.methods.treasury().call()
                    ]);

                    document.getElementById('isReflectionToken').textContent = isReflection ? 'Yes' : 'No';
                    document.getElementById('totalFeesCollected').textContent = formatTokenAmount(totalFees, srvDecimals);
                    document.getElementById('transferFee').textContent = (parseInt(feeStructure.transferFee.percentage) / 100).toFixed(2) + '%';
                    document.getElementById('burnFee').textContent = (parseInt(feeStructure.burn.percentage) / 100).toFixed(2) + '%';
                    document.getElementById('reflectionFee').textContent = (parseInt(feeStructure.reflection.percentage) / 100).toFixed(2) + '%';
                    document.getElementById('buybackFee').textContent = (parseInt(feeStructure.buyback.percentage) / 100).toFixed(2) + '%';
                    document.getElementById('maxSupply').textContent = formatTokenAmount(maxSupply, srvDecimals);
                    document.getElementById('treasuryAddress').textContent = treasury.substring(0, 10) + '...';
                }

            } catch (error) {
                console.error("Error loading global data:", error);
                showError("Could not load protocol data.");
            }
        }

        // Load user-specific data
        async function loadUserData() {
            if (!userAccount || !stakingContract || !srvContract || !srevContract) return;
            
            try {
                const [srvBalance, srevBalance, stakedAmount, srevTotalSupply, stakingVault, srevTokenName, srevTokenSymbol, gasPrice] = await Promise.all([
                    srvContract.methods.balanceOf(userAccount).call(),
                    srevContract.methods.balanceOf(userAccount).call(),
                    stakingContract.methods.staked(userAccount).call(),
                    srevContract.methods.totalSupply().call(),
                    srevContract.methods.stakingVault().call(),
                    srevContract.methods.name().call(),
                    srevContract.methods.symbol().call(),
                    web3.eth.getGasPrice()
                ]);

                // Main balances
                document.getElementById('srvBalance').textContent = formatTokenAmount(srvBalance, srvDecimals);
                document.getElementById('stakedAmount').textContent = formatTokenAmount(stakedAmount, srvDecimals);
                document.getElementById('userStaked').textContent = formatTokenAmount(stakedAmount, srvDecimals);

                // SREV token details
                document.getElementById('srevUserBalance').textContent = formatTokenAmount(srevBalance, srevDecimals);
                document.getElementById('srevSupply').textContent = formatTokenAmount(srevTotalSupply, srevDecimals);
                document.getElementById('srevTokenName').textContent = srevTokenName;
                document.getElementById('srevTokenSymbol').textContent = srevTokenSymbol;
                document.getElementById('srevDecimals').textContent = srevDecimals;

                // Sidebar
                document.getElementById('sidebarSrvBalance').textContent = formatTokenAmount(srvBalance, srvDecimals);
                document.getElementById('sidebarSrevBalance').textContent = `${formatTokenAmount(srevBalance, srevDecimals)} ${srevTokenSymbol}`;
                document.getElementById('sidebarStaked').textContent = formatTokenAmount(stakedAmount, srvDecimals);
                document.getElementById('stakingVaultAddress').textContent = stakingVault.substring(0, 10) + '...';
                document.getElementById('gasPrice').textContent = `${Math.round(web3.utils.fromWei(gasPrice, 'gwei'))} gwei`;

                checkAllowance();
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load user data.');
            }
        }
        
        // Check token allowance and update UI
        async function checkAllowance() {
            if (!userAccount || !srvContract) return;

            const stakeAmountInput = document.getElementById('stakeAmount');
            const approveBtn = document.getElementById('approveBtn');
            const stakeBtn = document.getElementById('stakeBtn');
            const amount = parseFloat(stakeAmountInput.value) || 0;

            if (amount === 0) {
                approveBtn.style.display = 'block';
                stakeBtn.disabled = true;
                return;
            }

            try {
                const amountWei = web3.utils.toWei(amount.toString(), 'ether');
                const allowance = await srvContract.methods.allowance(userAccount, STAKING_CONTRACT_ADDRESS).call();

                if (BigInt(allowance) >= BigInt(amountWei)) {
                    approveBtn.style.display = 'none';
                    stakeBtn.disabled = false;
                } else {
                    approveBtn.style.display = 'block';
                    stakeBtn.disabled = true;
                }
            } catch (error) {
                console.error("Could not check allowance:", error);
                approveBtn.style.display = 'block';
                stakeBtn.disabled = true;
            }
        }


        // Approve tokens
        async function approveTokens() {
            if (!srvContract || !userAccount) return showError('Please connect your wallet first.');
            
            const amount = document.getElementById('stakeAmount').value;
            if (!amount || amount <= 0) return showError('Please enter a valid amount to approve.');
            
            const approveBtn = document.getElementById('approveBtn');
            
            try {
                approveBtn.disabled = true;
                approveBtn.innerHTML = '<span class="loading"></span> Approving...';
                
                const amountWei = web3.utils.toWei(amount, 'ether');
                await srvContract.methods.approve(STAKING_CONTRACT_ADDRESS, amountWei).send({ from: userAccount });
                
                showSuccess('Tokens approved successfully!');
                await checkAllowance(); // Re-check allowance to update UI
                
            } catch (error) {
                console.error('Approval error:', error);
                showError(`Approval failed: ${error.message}`);
            } finally {
                approveBtn.disabled = false;
                approveBtn.innerHTML = 'Approve SRV';
            }
        }

        // Stake tokens
        async function stakeTokens() {
            if (!stakingContract || !userAccount) return showError('Please connect your wallet first.');
            
            const amount = document.getElementById('stakeAmount').value;
            if (!amount || amount <= 0) return showError('Please enter a valid amount to stake.');
            
            const stakeBtn = document.getElementById('stakeBtn');

            try {
                stakeBtn.disabled = true;
                stakeBtn.innerHTML = '<span class="loading"></span> Staking...';
                
                const amountWei = web3.utils.toWei(amount, 'ether');
                await stakingContract.methods.stake(amountWei).send({ from: userAccount });
                
                showSuccess('Tokens staked successfully!');
                document.getElementById('stakeAmount').value = '';
                await loadUserData();
                addTransaction('Stake', `${amount} SRV`);
                
            } catch (error) {
                console.error('Staking error:', error);
                showError(`Staking failed: ${error.message}`);
            } finally {
                stakeBtn.disabled = false;
                stakeBtn.innerHTML = 'Stake SRV';
            }
        }

        // Unstake tokens
        async function unstakeTokens() {
            if (!stakingContract || !userAccount) return showError('Please connect your wallet first.');
            
            const amount = document.getElementById('unstakeAmount').value;
            if (!amount || amount <= 0) return showError('Please enter a valid amount to unstake.');

            const unstakeBtn = document.getElementById('unstakeBtn');
            
            try {
                unstakeBtn.disabled = true;
                unstakeBtn.innerHTML = '<span class="loading"></span> Unstaking...';
                
                const amountWei = web3.utils.toWei(amount, 'ether');
                await stakingContract.methods.unstake(amountWei).send({ from: userAccount });
                
                showSuccess('Tokens unstaked successfully!');
                document.getElementById('unstakeAmount').value = '';
                await loadUserData();
                addTransaction('Unstake', `${amount} SRV`);
                
            } catch (error) {
                console.error('Unstaking error:', error);
                showError(`Unstaking failed: ${error.message}`);
            } finally {
                unstakeBtn.disabled = false;
                unstakeBtn.innerHTML = 'Unstake SRV';
            }
        }

        // Claim rewards
        async function claimRewards() {
            if (!rewardsContract || !userAccount) return showError('Please connect your wallet first.');
            
            const claimBtn = document.getElementById('claimRewardsBtn');

            try {
                claimBtn.disabled = true;
                claimBtn.innerHTML = '<span class="loading"></span> Claiming...';
                
                await rewardsContract.methods.claim().send({ from: userAccount });
                
                showSuccess('Rewards claimed successfully!');
                await loadUserData();
                addTransaction('Claim Rewards', 'Business Revenue');
                
            } catch (error) {
                console.error('Claim error:', error);
                showError(`Claim failed: ${error.message}`);
            } finally {
                claimBtn.disabled = false;
                claimBtn.innerHTML = 'Claim Rewards';
            }
        }

        // Helper functions
        function formatTokenAmount(amount, decimals) {
            if (!amount || amount.toString() === '0') return '0.00';
            const divisor = decimals.toString() === '6' ? 'mwei' : 'ether';
            const value = parseFloat(web3.utils.fromWei(amount.toString(), divisor));
            return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 4 });
        }

        function formatTime(seconds) {
            seconds = Number(seconds);
            if (seconds === 0) return "Ready";
            const d = Math.floor(seconds / (3600*24));
            const h = Math.floor(seconds % (3600*24) / 3600);
            const m = Math.floor(seconds % 3600 / 60);

            let display = [];
            if (d > 0) display.push(`${d}d`);
            if (h > 0) display.push(`${h}h`);
            if (m > 0) display.push(`${m}m`);
            return display.length > 0 ? display.slice(0, 2).join(' ') : "<1m";
        }

        function setMaxStake() {
            const balance = document.getElementById('srvBalance').textContent.replace(/,/g, '');
            document.getElementById('stakeAmount').value = balance;
            checkAllowance();
        }

        function setMaxUnstake() {
            const staked = document.getElementById('stakedAmount').textContent.replace(/,/g, '');
            document.getElementById('unstakeAmount').value = staked;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => { successDiv.style.display = 'none'; }, 5000);
        }

        function addTransaction(type, amount) {
            const transactionList = document.getElementById('transactionList');
            const transactionItem = document.createElement('div');
            transactionItem.className = 'transaction-item';
            transactionItem.innerHTML = `
                <div class="transaction-details">
                    <div class="transaction-type">${type}</div>
                    <div class="transaction-time">Just now</div>
                </div>
                <div class="transaction-amount">${amount}</div>
            `;
            
            if (transactionList.innerHTML.includes('No transactions yet')) {
                transactionList.innerHTML = '';
            }
            
            transactionList.prepend(transactionItem);
        }

        function resetUI() {
            const fieldsToReset = {
                'srvBalance': '0', 'stakedAmount': '0', 'userStaked': '0',
                'rewardPoolBalance': '$0.00', 'pendingRewards': '$0.00', 'rewardPoolStat': '$0',
                'aprDisplay': '5%', 'currentAPR': '5% APR',
                'srevUserBalance': '0', 'srevSupply': '0', 'srevTokenName': 'Loading...',
                'srevTokenSymbol': 'Loading...', 'isReflectionToken': 'Loading...', 'totalFeesCollected': '0',
                'transferFee': '0.00%', 'burnFee': '0.00%', 'reflectionFee': '0.00%', 'buybackFee': '0.00%',
                'maxSupply': 'Loading...', 'treasuryAddress': 'Loading...', 'sidebarSrvBalance': '0',
                'sidebarSrevBalance': '0', 'sidebarStaked': '0', 'pendingRewardsSidebar': '$0.00',
                'networkName': 'Not connected', 'gasPrice': '-- gwei', 'srvTokenAddress': 'Loading...',
                'srevTokenAddress': 'Loading...', 'stakingVaultAddress': 'Loading...',
                'rewardsContractAddress': 'Loading...', 'rewardTokenAddress': 'Loading...', 'totalStaked': 'Loading...'
            };
            for (const id in fieldsToReset) {
                const element = document.getElementById(id);
                if (element) element.textContent = fieldsToReset[id];
            }
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else if (accounts[0] !== userAccount) {
                userAccount = accounts[0];
                updateConnectionStatus(true);
                loadUserData();
            }
        }

        function handleChainChanged() {
            window.location.reload();
        }

        // Event Listeners
        document.getElementById('stakeAmount').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9.]/g, '');
            checkAllowance();
        });

        document.getElementById('unstakeAmount').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9.]/g, '');
        });

        // Periodic updates for rewards
        setInterval(async () => {
            if (userAccount && rewardsContract) {
                try {
                    const pendingRewards = await rewardsContract.methods.viewPending(userAccount).call();
                    const claimCooldown = await rewardsContract.methods.viewClaimCooldown(userAccount).call();
                    
                    const formattedRewards = '$' + formatTokenAmount(pendingRewards, rewardTokenDecimals);
                    document.getElementById('pendingRewards').textContent = formattedRewards;
                    document.getElementById('pendingRewardsSidebar').textContent = formattedRewards;
                    
                    const cooldownStatus = document.getElementById('claimCooldownStatus');
                    const claimBtn = document.getElementById('claimRewardsBtn');
                    
                    if (BigInt(claimCooldown) > 0) {
                        cooldownStatus.textContent = `Next claim in ${formatTime(claimCooldown)}`;
                        claimBtn.disabled = true;
                        claimBtn.textContent = 'Cooldown Active';
                    } else if (BigInt(pendingRewards) === 0n) {
                        cooldownStatus.textContent = 'No pending rewards';
                        claimBtn.disabled = true;
                        claimBtn.textContent = 'No Rewards';
                    } else {
                        cooldownStatus.textContent = 'Ready to claim!';
                        claimBtn.disabled = false;
                        claimBtn.textContent = 'Claim Rewards';
                    }
                } catch (error) {
                    // Fail silently on interval updates to avoid spamming user with popups
                    console.error('Error updating rewards data:', error);
                }
            }
        }, 15000); // Update every 15 seconds

        // Initialize on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
